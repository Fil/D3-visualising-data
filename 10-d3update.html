<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: D3 - Transitions</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">D3 - Transitions</h1>
          <h2 class="subtitle">On bouge!</h2>
<div id="objectifs-du-cours" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="objectifs-du-cours" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Objectifs du cours</h2>
</div>
<div class="panel-body">
<ul>
<li>Utiliser un slider</li>
<li>Mettre à jour des points avec d3.transition</li>
<li>Tout regrouper dans un dernier effort!</li>
</ul>
</div>
</div>
<p>Dans notre code, l’année à laquelle nous regardons les données est codée « en dur » : il s’agit de l’année 2009, dernière de la série.</p>
<p>Maintenant nous souhaitons que l’utilisateur puisse observer l’évolution de ces données au fil du temps.</p>
<p>Faisons cela avec un curseur de défilement (slider). La première chose à faire est d’ajouter ce slider ) notre interface (notre page). En HTML il s’agit tout simplement d’un élément <code>input</code> de type <code>range</code>. Nous lui attribuons un identifiant de façon à pouvoir le sélectionner depuis notre script, une classe pour pouvoir lui affecter un style (si on le souhaite), et des valeurs minimum, maximum, et de pas qui dépendent de nos données. <code>value</code> est la propriété qui nous permet de savoir à quelle position le slider est réglé. Initialisons-le quelque part au milieu de notre série (1979).</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;range&quot;</span><span class="ot"> name=</span><span class="st">&quot;range&quot;</span><span class="ot"> class=</span><span class="st">&quot;slider&quot;</span><span class="ot"> id=</span><span class="st">&quot;year_slider&quot;</span><span class="ot"> value=</span><span class="st">&quot;1979&quot;</span><span class="ot"> min=</span><span class="st">&quot;1950&quot;</span><span class="ot"> max=</span><span class="st">&quot;2008&quot;</span><span class="ot"> step=</span><span class="st">&quot;1&quot;</span> <span class="kw">&gt;&lt;br&gt;</span></code></pre></div>
<p>Dans notre script, l’année est une variable, nous devons l’intialiser. Comme <code>value</code> est une chaîne de caractères et non un nombre, nous devons d’abord le convertir avec <code>parseInt()</code>. Pour ensuite récupérer l’index (et non l’année), il suffit de retrancher la valeur de la première année de la série, 1950.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> year_idx <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;year_slider&quot;</span>).<span class="at">value</span>)<span class="op">-</span><span class="dv">1950</span><span class="op">;</span></code></pre></div>
<p>Mettre à jour l’année devient relativement simple. Il suffit d’ajouter un nouveau listener qui modifie la variable <code>year</code>lorsque nous touchons au slider. L’événement que l’on souhaite écouter s’appelle <code>input</code>. On exécute alors la fonction <code>update()</code> définie précédemment.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">d3</span>.<span class="at">select</span>(<span class="st">&quot;#year_slider&quot;</span>).<span class="at">on</span>(<span class="st">&quot;input&quot;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span>
    year_idx <span class="op">=</span> <span class="at">parseInt</span>(<span class="kw">this</span>.<span class="at">value</span>) <span class="op">-</span> <span class="dv">1950</span><span class="op">;</span>
    <span class="at">update</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>Jusqu’ici la fonction update ne sait que gérer des ajouts et des suppressions de données, avec <code>.enter</code> et <code>.exit</code>; que faire lorsque des données évoluent? En plus de <code>d3.enter()</code> et <code>d3.exit()</code>, D3 offre <code>d3.transition</code> qui permet de gérer la mise à jour des données**. Mais d’abord il faut définir comment on passe d’une valeur à la suivante. Nous pouvons souhaiter faire une interpolation linéaire des valeurs sur une durée de 200ms, comme ceci:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">dot</span>.<span class="at">transition</span>().<span class="at">ease</span>(<span class="st">&quot;linear&quot;</span>).<span class="at">duration</span>(<span class="dv">200</span>)<span class="op">;</span></code></pre></div>
<p>Il reste à dire vers quelle valeur on va effectuer la transition. Pour cela, déplaçons le bout de code qui met à jour le cercle, en le retirant de <code>enter()</code> pour le mettre dans la partie <code>transition()</code>. Et, à la place de l’index en dur pour aller chercher l’année, on va se baser sur la valeur de <code>year_idx</code>, qui a été mise à jour un peu avant dans notre listener.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">dot</span>.<span class="at">enter</span>().<span class="at">append</span>(<span class="st">&quot;circle&quot;</span>).<span class="at">attr</span>(<span class="st">&quot;class&quot;</span><span class="op">,</span><span class="st">&quot;dot&quot;</span>)
        .<span class="at">style</span>(<span class="st">&quot;fill&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">colorScale</span>(<span class="va">d</span>.<span class="at">region</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span>
<span class="va">dot</span>.<span class="at">exit</span>().<span class="at">remove</span>()<span class="op">;</span>
<span class="va">dot</span>.<span class="at">transition</span>().<span class="at">ease</span>(<span class="st">&quot;linear&quot;</span>).<span class="at">duration</span>(<span class="dv">200</span>)
                .<span class="at">attr</span>(<span class="st">&quot;cx&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">xScale</span>(<span class="va">d</span>.<span class="at">income</span>[year_idx])<span class="op">;</span> <span class="op">}</span>) <span class="co">// voici comment attr sait quelle donnée il doit considérer</span>
                .<span class="at">attr</span>(<span class="st">&quot;cy&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">yScale</span>(<span class="va">d</span>.<span class="at">lifeExpectancy</span>[year_idx])<span class="op">;</span> <span class="op">}</span>)
                .<span class="at">attr</span>(<span class="st">&quot;r&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">rScale</span>(<span class="va">d</span>.<span class="at">population</span>[year_idx])<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span></code></pre></div>
<div id="dautres-fonctions-de-transition-sont-possibles" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="dautres-fonctions-de-transition-sont-possibles" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>D’autres fonctions de transition sont possibles</h2>
</div>
<div class="panel-body">
<ul>
<li>sin - applique la fonction trigonométrique sinus().</li>
<li>exp - exponentielle.</li>
<li>bounce - simule une collision avec un rebond.</li>
<li>elastic(a, p) - simulates un élastique; cette fonction peut dépasser un peu des bornes 0 et 1.</li>
<li><a href="https://github.com/mbostock/d3/wiki/Transitions#d3_ease">pour en savoir plus</a></li>
</ul>
</div>
</div>
<div id="cest-lheure-de-samuser" class="challenge panel panel-success">
<div class="panel-heading">
<h1 id="cest-lheure-de-samuser" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>C’est l’heure de s’amuser</h1>
</div>
<div class="panel-body">
<p>D3 est incroyablement versatile. ESsayez différentes transitions et, si vous avez du temps, voyez comment dessiner des rectangles à la place des cercles.</p>
</div>
</div>
<p>Ensuite, nous voulons créer un pop-up. Regardons un peu ce qui existe déjà sur internet. Il existe beaucoup d’exemples de code utilisant D3. Voici un exemple de <a href="http://bl.ocks.org/biovisualize/1016860">simple pop-up</a>. Pour suivre cet exemple nous commençons par créer la variable tooltip:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> tooltip <span class="op">=</span> <span class="va">d3</span>.<span class="at">select</span>(<span class="st">&quot;body&quot;</span>)
    .<span class="at">append</span>(<span class="st">&quot;div&quot;</span>)
    .<span class="at">style</span>(<span class="st">&quot;position&quot;</span><span class="op">,</span> <span class="st">&quot;absolute&quot;</span>)  
    .<span class="at">style</span>(<span class="st">&quot;visibility&quot;</span><span class="op">,</span> <span class="st">&quot;hidden&quot;</span>)<span class="op">;</span></code></pre></div>
<p>puis nous créons un listener pour les événements de survol des cercles avec la souris. Le code cidessous permet d’afficher le pays que l’on survole, le pop-up va suivre le mouvement de la souris, et quand on quitte le cercle, le popup doit disparaître.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">dot</span>.<span class="at">enter</span>().<span class="at">append</span>(<span class="st">&quot;circle&quot;</span>).<span class="at">attr</span>(<span class="st">&quot;class&quot;</span><span class="op">,</span><span class="st">&quot;dot&quot;</span>)                        
            .<span class="at">style</span>(<span class="st">&quot;fill&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">colorScale</span>(<span class="va">d</span>.<span class="at">region</span>)<span class="op">;</span> <span class="op">}</span>)
            .<span class="at">on</span>(<span class="st">&quot;mouseover&quot;</span><span class="op">,</span> <span class="kw">function</span>(d)<span class="op">{</span><span class="cf">return</span> <span class="va">tooltip</span>.<span class="at">style</span>(<span class="st">&quot;visibility&quot;</span><span class="op">,</span> <span class="st">&quot;visible&quot;</span>).<span class="at">text</span>(<span class="va">d</span>.<span class="at">name</span>)<span class="op">;}</span>)
            .<span class="at">on</span>(<span class="st">&quot;mousemove&quot;</span><span class="op">,</span> <span class="kw">function</span>()<span class="op">{</span><span class="cf">return</span> <span class="va">tooltip</span>.<span class="at">style</span>(<span class="st">&quot;top&quot;</span><span class="op">,</span> (<span class="va">d3</span>.<span class="va">event</span>.<span class="at">pageY</span><span class="dv">-10</span>)<span class="op">+</span><span class="st">&quot;px&quot;</span>).<span class="at">style</span>(<span class="st">&quot;left&quot;</span><span class="op">,</span>(<span class="va">d3</span>.<span class="va">event</span>.<span class="at">pageX</span><span class="dv">+10</span>)<span class="op">+</span><span class="st">&quot;px&quot;</span>)<span class="op">;}</span>)
            .<span class="at">on</span>(<span class="st">&quot;mouseout&quot;</span><span class="op">,</span> <span class="kw">function</span>()<span class="op">{</span><span class="cf">return</span> <span class="va">tooltip</span>.<span class="at">style</span>(<span class="st">&quot;visibility&quot;</span><span class="op">,</span> <span class="st">&quot;hidden&quot;</span>)<span class="op">;}</span>)<span class="op">;</span></code></pre></div>
<div id="nous-avons-exploité-différents-objets-donnés-par-le-navigateur" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="nous-avons-exploité-différents-objets-donnés-par-le-navigateur" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Nous avons exploité différents objets donnés par le navigateur</h2>
</div>
<div class="panel-body">
<ul>
<li>document.x - sélectionner des choses sur la page (getElementById)</li>
<li>console.x - afficher un élément dans la console (log)</li>
<li>event.x - dans le cadre d’un événement comme “mouseover”, &quot;mousemove&quot;, ou “keydown”. Renvoie des détails sur l’événement (pageX - où cet événement s’est-il produit dans la page?).</li>
</ul>
</div>
</div>
<p>Comme tout langage de programmation, Javascript peut aussi servir à faire des calculs statistiques avec nos données. Comme exemple, calculons la moyenne de l’espérance de vie et du revenu par habitant dans les différentes régions.</p>
<p>On commence par faire le tour des pays en les groupant par région:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="co">// Calculate the averages for each region.</span>
<span class="kw">var</span> region_names <span class="op">=</span> [<span class="st">&quot;Sub-Saharan Africa&quot;</span><span class="op">,</span> <span class="st">&quot;South Asia&quot;</span><span class="op">,</span> <span class="st">&quot;Middle East &amp; North Africa&quot;</span><span class="op">,</span> <span class="st">&quot;America&quot;</span><span class="op">,</span> <span class="st">&quot;East Asia &amp; Pacific&quot;</span><span class="op">,</span> <span class="st">&quot;Europe &amp; Central Asia&quot;</span>]<span class="op">;</span>

<span class="kw">var</span> region_data <span class="op">=</span> []<span class="op">;</span>
<span class="cf">for</span> (<span class="kw">var</span> i <span class="kw">in</span> region_names) <span class="op">{</span>
    <span class="kw">var</span> filtered_nations_by_regions <span class="op">=</span> <span class="va">nations</span>.<span class="at">filter</span>(<span class="kw">function</span>(nation)<span class="op">{</span>
        <span class="cf">return</span> (<span class="va">nation</span>.<span class="at">region</span> <span class="op">==</span> region_names[i])<span class="op">;</span> 
    <span class="op">}</span>)<span class="op">;</span>
    region_data[i] <span class="op">=</span> <span class="at">calc_mean</span>(filtered_nations_by_regions)<span class="op">;</span>
<span class="op">}</span>

<span class="kw">var</span> filtered_reg_nations <span class="op">=</span> <span class="va">region_data</span>.<span class="at">map</span>(<span class="kw">function</span>(region) <span class="op">{</span> <span class="cf">return</span> region<span class="op">;}</span>)<span class="op">;</span></code></pre></div>
<p>Ensuite, on crée une fonction qui renvoie un tableau d’objets region_data. On souhaite qu’il contienne la moyenne du revenu par habitant et de l’espérance de vie année par année, à travers toutes les nations, pondérées par la population.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">calc_mean</span>(region_data) <span class="op">{</span>
    <span class="kw">var</span> mean_income <span class="op">=</span> []<span class="op">;</span>
    <span class="kw">var</span> mean_lifeExpectancy <span class="op">=</span> []<span class="op">;</span>

    <span class="cf">for</span> (<span class="kw">var</span> year_idx2 <span class="kw">in</span> region_data[<span class="dv">0</span>].<span class="at">years</span>) <span class="op">{</span>
        <span class="kw">var</span> sum_income <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>
        <span class="kw">var</span> sum_lifeExpectancy <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>
        <span class="kw">var</span> sum_population <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>

        <span class="cf">for</span> (<span class="kw">var</span> k <span class="kw">in</span> region_data) <span class="op">{</span>
            <span class="kw">var</span> kpop <span class="op">=</span> region_data[k].<span class="at">population</span>[year_idx2]<span class="op">;</span>
            <span class="kw">var</span> kincome <span class="op">=</span> region_data[k].<span class="at">income</span>[year_idx2]<span class="op">;</span>
            <span class="kw">var</span> klife <span class="op">=</span> region_data[k].<span class="at">lifeExpectancy</span>[year_idx2]<span class="op">;</span>
            sum_income <span class="op">+=</span> kpop<span class="op">*</span>kincome<span class="op">;</span> 
            sum_lifeExpectancy <span class="op">+=</span> kpop<span class="op">*</span>klife<span class="op">;</span>
            sum_population <span class="op">+=</span> kpop<span class="op">;</span>             
        <span class="op">}</span>

        mean_income[year_idx2] <span class="op">=</span> sum_income/sum_population<span class="op">;</span>
        mean_lifeExpectancy[year_idx2] <span class="op">=</span> sum_lifeExpectancy/sum_population<span class="op">;</span>
    <span class="op">}</span>
    averageData <span class="op">=</span> <span class="op">{</span>
        <span class="dt">region</span><span class="op">:</span> region_data[<span class="dv">0</span>].<span class="at">region</span><span class="op">,</span>
        <span class="dt">years</span><span class="op">:</span> region_data[<span class="dv">0</span>].<span class="at">years</span><span class="op">,</span>
        <span class="dt">mean_income</span><span class="op">:</span> mean_income<span class="op">,</span>
        <span class="dt">mean_lifeExpectancy</span><span class="op">:</span> mean_lifeExpectancy
    <span class="op">};</span>

    <span class="cf">return</span> averageData<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<div id="le-grand-défi" class="challenge panel panel-success">
<div class="panel-heading">
<h1 id="le-grand-défi" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>Le grand défi</h1>
</div>
<div class="panel-body">
<p>Il est temps de mettre ensemble tout ce que nous avons appris. Ecrire du code qui affiche (et met à jour) les valeurs moyennes que nous venons de calculer sous forme de petites croix dans le graphique, une croix figurant chaque région.</p>
</div>
</div>
<div id="style" class="challenge panel panel-success">
<div class="panel-heading">
<h1 id="style" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>...style!</h1>
</div>
<div class="panel-body">
<p>Ajouter des étiquettes aux axes et choisir de jolies polices de caractères.</p>
</div>
</div>
<div id="utiliser-dautres-formats-de-données" class="challenge panel panel-success">
<div class="panel-heading">
<h1 id="utiliser-dautres-formats-de-données" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>Utiliser d’autres formats de données</h1>
</div>
<div class="panel-body">
<p>Essayer de charger nations.csv à la place de nations.json - pour produire le même graphique.</p>
</div>
</div>
<p>À la fin de cette leçon, votre page doit resembler à ceci:</p>
<iframe src="http://isakiko.github.io/D3-visualising-data/code/index10.html" width="1000" height="600">
</iframe>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/swcarpentry/lesson-template">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
