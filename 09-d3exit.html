<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: D3 - Ajouter et supprimer</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">D3 - Ajouter et supprimer</h1>
          <h2 class="subtitle">Ajout dynamique de points de données</h2>
<div id="objectifs-de-la-leçon" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="objectifs-de-la-leçon" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Objectifs de la leçon</h2>
</div>
<div class="panel-body">
<ul>
<li>Filtrer les données</li>
<li>Créer des cases à cocher</li>
<li>Ajouter et supprimer des points de données (d3.enter et d3.exit)</li>
</ul>
</div>
</div>
<p>Notre graphique est assez chargé. On ne souhaite pas forcément tout afficher tout le temps. L’objectif de cette leçon est de mettre à jour le graphique en fonction des données que l’on veut afficher.</p>
<p>TOu d’abord il nous faut une manière de filtrer nos données. Pour cela nous allons utiliser la fonction <code>filter</code>. Comme la fonction <code>.map()</code> vue précédemment, cette fonction s’applique à chacun des éléments de la liste <code>nations</code> (l’appelant temporairement <code>nation</code>). Elle n’inclut ensuite dans la nouvelle liste <code>filtered_nations</code> que les éléments pour lesquels la fonction a renvoyé une valeur équivalente à ‘true’. Ici ce sera le cas pour les nations dont la population en 2009 était supérieure à 10 millions d’habitants.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> filtered_nations <span class="op">=</span> <span class="va">nations</span>.<span class="at">filter</span>(<span class="kw">function</span>(nation)<span class="op">{</span> 
    <span class="cf">return</span> <span class="va">nation</span>.<span class="at">population</span>[<span class="va">nation</span>.<span class="va">population</span>.<span class="at">length</span><span class="dv">-1</span>] <span class="op">&gt;</span> <span class="dv">10000000</span><span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<div id="filtrer-par-région" class="challenge panel panel-success">
<div class="panel-heading">
<h1 id="filtrer-par-région" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>Filtrer par région</h1>
</div>
<div class="panel-body">
<p>Vous avez peut-être remarqué que nos données contiennent des informations sur la région à laquelle appartient un pays.</p>
<ol style="list-style-type: decimal">
<li>Créer un filtre qui permette de n’afficher que des poins de données appartenant à la région d’Afrique sub-saharienne.</li>
</ol>
</div>
</div>
<p>Nous venons de coder en dur un critère pour les données que nous voulons afficher. Naturellement, nous voulons que ce changement se fasse de manière interactive. Créons quelques cases à cocher qui nous permettront d’ajouter les régions que nous souhaitons prendre en compte.</p>
<p>Pour faire ceci, il nous faut revenir un moment à notre fichier HTML. Nous allons y créer une case à cocher pour chaque région. Au départ, chaque case sera cochée, pour que le graphique démarre avec tout le contenu. En HTML, une case à cocher se fait avec un élément input de type checkbox:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;label&gt;&lt;input</span><span class="ot"> type=</span><span class="st">&quot;checkbox&quot;</span><span class="ot"> name=</span><span class="st">&quot;region&quot;</span><span class="ot"> class=</span><span class="st">&quot;region_cb&quot;</span><span class="ot"> value=</span><span class="st">&quot;Sub-Saharan Africa&quot;</span><span class="ot"> checked=</span><span class="st">&quot;checked&quot;</span><span class="kw">/&gt;</span> Sub-Saharan Africa<span class="kw">&lt;/label&gt;</span></code></pre></div>
<p>L’étape suivante est d’ajouter un listener qui sera activé à chaque modification des cases à cocher de la page. D3 fournit des outils très pratiques dans ce cas de figure, et permet notamment de récupérer la valeur de chaque option, qui viendra nourrir notre filtre.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">d3</span>.<span class="at">selectAll</span>(<span class="st">&quot;.region_cb&quot;</span>).<span class="at">on</span>(<span class="st">&quot;change&quot;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span> <span class="op">&lt;---</span> ici se passe l<span class="st">&#39;action ---&gt; });</span></code></pre></div>
<p>Cette ligne écoute tous les changements d’état des cases à cocher portant la classe <code>region_cb</code>. À chaque modification d’état, qu’il s’agisse de cocher ou de décocher une case, la fonction de rappel est exécutée.</p>
<p>À l’intérieur de cette fonction, on va lire les données de la case à cocher, que l’on a préalablement réglées comme étant le nom de chaque région. Le mot-clé <code>this</code> dans la fonction de rappel fait référence à l’élément qui vient d’être cliqué, on peut donc récupérer sa valeur.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> type <span class="op">=</span> <span class="kw">this</span>.<span class="at">value</span><span class="op">;</span></code></pre></div>
<p>Maintenant que le nom de la région est enregistré dans la variable <code>type</code>, il nous faut ajouter les points de données correspondants si la case à cocher est activée. On vérifie si elle est cochée ou non en regardant son attribut <code>this.checked</code>. Pour ajouter les nouvelles nations à <code>filtered_nations</code>, on utilise la fonction <code>concat</code> qui met bout à bout deux tableaux. On ajoute donc <code>new_nations</code> à la fin de <code>filtered_nations</code>.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="cf">if</span> (<span class="kw">this</span>.<span class="at">checked</span>) <span class="op">{</span> <span class="co">// adding data points </span>
  <span class="kw">var</span> new_nations <span class="op">=</span> <span class="va">nations</span>.<span class="at">filter</span>(<span class="kw">function</span>(nation)<span class="op">{</span> <span class="cf">return</span> <span class="va">nation</span>.<span class="at">region</span> <span class="op">==</span> type<span class="op">;}</span>)<span class="op">;</span>
  filtered_nations <span class="op">=</span> <span class="va">filtered_nations</span>.<span class="at">concat</span>(new_nations)<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>Cette clause <code>if</code> est exécutée à chaque fois qu’on clique sur une case à cocher. Pour ajouter les points de données, on peut utiliser la fonction <code>push</code>, qui ajoute les éléments un par un. Pour cela, on filtre les nations qu’on veut ajouter, en les appelant <code>new_nations</code>. Ensuite on boucle sur toutes ces nations et on les ajoute une par une à la liste <code>filtered_nations</code>.</p>
<p>Au préalable il aura fallu initialiser <code>filtered_nations</code> au début de notre script. Comme il existe une différence entre l’espace des noms et l’espace des objets, il faut se souvenir d’utiliser <code>.map()</code> pour cloner les données, et pas seulement <code>=</code>.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> filtered_nations <span class="op">=</span> <span class="va">nations</span>.<span class="at">map</span>(<span class="kw">function</span>(nation) <span class="op">{</span> <span class="cf">return</span> nation<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>Au départ <code>filtered_nations</code> est identique à <code>nations</code> car toutes les cases sont cochées, on affiche les données de toues les nations. Cela signifie que tout changement dans les cases à cocher à cette étape les fera basculer dans l’état « non coché »; il nous faut donc un code à actvier pour enlever des éléments quand une case est décochée.</p>
<p>Avant de faire ceci, nous devons apprendre à supprimer des éléments en D3. Cela se fait avec la fonction <code>exit()</code>.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">dot</span>.<span class="at">exit</span>().<span class="at">remove</span>()<span class="op">;</span></code></pre></div>
<p>Là où on utilisait <code>enter()</code> pour ajouter de nouveaux éléments au grpahique, <code>exit()</code> va nous permettre de supprimer des éléments qui ne sont plus présents dans le jeu de données (les pays appartenant à des régions décochées). Les deux fonctions comparent les données demandées à celles qui sont sur le graphique. Comme pour <code>enter()</code>, tout ce qui suit <code>exit()</code> est actionné pour chacun des éléments dont les données ont « disparu ». Ici, comme dans la plupart des cas, on va vouloir supprimer ces éléments graphiques.</p>
<p>Une bonne explication de ce lien entre les données et les éléments est formulée <a href="http://bost.ocks.org/mike/join/">ici</a>. Cet article détaille les trois fonctionnalités importantes: <code>enter</code>, <code>exit</code>, et une troisième, <code>update</code>, que nous allons bientôt présenter.</p>
<div id="supprimer-des-éléments" class="challenge panel panel-success">
<div class="panel-heading">
<h1 id="supprimer-des-éléments" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>Supprimer des éléments</h1>
</div>
<div class="panel-body">
<ol style="list-style-type: decimal">
<li>En utilisant un cas <code>else</code> après le <code>if</code>, créer un filtre qui supprime les éléments de <code>filtered_data</code> qui correspondent aux cases à cocher qui viennent d’être décochées. (par exemple <code>else { filtered_nations = &lt;--- remplir cette partie ---&gt;}</code>).</li>
</ol>
</div>
</div>
<p>Dernière étape : déplaçons <code>enter()</code> et <code>exit()</code> dans une fonction à part. Ceci sera utile quand nous voudrons mettre à jour les données de différents éléments de la page.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">update</span>() <span class="op">{</span>
  <span class="kw">var</span> dot <span class="op">=</span> <span class="va">data_canvas</span>.<span class="at">selectAll</span>(<span class="st">&quot;.dot&quot;</span>).<span class="at">data</span>(filtered_nations<span class="op">,</span> <span class="kw">function</span>(d)<span class="op">{</span><span class="cf">return</span> <span class="va">d</span>.<span class="at">name</span><span class="op">}</span>)<span class="op">;</span>

  <span class="va">dot</span>.<span class="at">enter</span>().<span class="at">append</span>(<span class="st">&quot;circle&quot;</span>).<span class="at">attr</span>(<span class="st">&quot;class&quot;</span><span class="op">,</span><span class="st">&quot;dot&quot;</span>)                
                .<span class="at">style</span>(<span class="st">&quot;fill&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">colorScale</span>(<span class="va">d</span>.<span class="at">region</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span>
                .<span class="at">attr</span>(<span class="st">&quot;cx&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">xScale</span>(<span class="va">d</span>.<span class="at">income</span>[<span class="va">d</span>.<span class="va">income</span>.<span class="at">length</span><span class="dv">-1</span>])<span class="op">;</span> <span class="op">}</span>) <span class="co">// this is how attr knows to work with the data</span>
                .<span class="at">attr</span>(<span class="st">&quot;cy&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">yScale</span>(<span class="va">d</span>.<span class="at">lifeExpectancy</span>[<span class="va">d</span>.<span class="va">lifeExpectancy</span>.<span class="at">length</span><span class="dv">-1</span>])<span class="op">;</span> <span class="op">}</span>)
                .<span class="at">attr</span>(<span class="st">&quot;r&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">rScale</span>(<span class="va">d</span>.<span class="at">population</span>[<span class="va">d</span>.<span class="va">population</span>.<span class="at">length</span><span class="dv">-1</span>])<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span>

  <span class="va">dot</span>.<span class="at">exit</span>().<span class="at">remove</span>()<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>Désormais, nous pouvons appeler cette fonction de mise à jour (update) depuis notre listener qui surveille les changements d’état des cases à cocher, juste après avoir mis à jour la sélection <code>filtered_nations</code>:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">d3</span>.<span class="at">selectAll</span>(<span class="st">&quot;.region_cb&quot;</span>).<span class="at">on</span>(<span class="st">&quot;change&quot;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">var</span> type <span class="op">=</span> <span class="kw">this</span>.<span class="at">value</span><span class="op">;</span>
  <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">checked</span>) <span class="op">{</span> <span class="co">// adding data points (not quite right yet)</span>
    <span class="kw">var</span> new_nations <span class="op">=</span> <span class="va">nations</span>.<span class="at">filter</span>(<span class="kw">function</span>(nation)<span class="op">{</span> <span class="cf">return</span> <span class="va">nation</span>.<span class="at">region</span> <span class="op">==</span> type<span class="op">;}</span>)<span class="op">;</span>
    filtered_nations <span class="op">=</span> <span class="va">filtered_nations</span>.<span class="at">concat</span>(new_nations)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="co">// remove data points from the data that match the filter</span>
    filtered_nations <span class="op">=</span> <span class="va">filtered_nations</span>.<span class="at">filter</span>(<span class="kw">function</span>(nation)<span class="op">{</span> <span class="cf">return</span> <span class="va">nation</span>.<span class="at">region</span> <span class="op">!=</span> type<span class="op">;}</span>)<span class="op">;</span>
  <span class="op">}</span>
  <span class="at">update</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>Pour créer le graphique à l’ouverture de la page, on appelle aussi <code>update()</code> une fois hors des listeners.</p>
<div id="ajouter-une-dimension" class="challenge panel panel-success">
<div class="panel-heading">
<h1 id="ajouter-une-dimension" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>Ajouter une dimension</h1>
</div>
<div class="panel-body">
<ol style="list-style-type: decimal">
<li>On souhaite que la couleur des cercles représente la région. Créer une échelle de couleurs avec category20(). Il faudra alors ajouter <code>.style(&quot;fill&quot;, function(d) { &lt;-- remplir cette partie ---&gt; });</code> dans la fonction enter().</li>
</ol>
</div>
</div>
<p>Au terme de cette leçon, votre page devrait ressembler à ceci:</p>
<iframe src="http://isakiko.github.io/D3-visualising-data/code/index09.html" width="1000" height="600">
</iframe>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/swcarpentry/lesson-template">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
